---
title: "Extract Transform Load - ACO"
author: "Karen Jiang"
date: "2/26/2020"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(tidyverse)
library(readr)
library(readxl)
library(gt)
library(purrr)
```

## Exploratory Data Analysis - Part 1

We are examining 3 datasets from CMS.

* **ACO general information**
* Beneficiaries information by ACO
* Fee-for-Service Expenditures by ACO

To better understand how MSSP scoring and classifications for ACOs, information can be found in the  [MSSP Shared Savings and Losses Assignement and Methodology ]("https://www.cms.gov/Medicare/Medicare-Fee-for-Service-Payment/sharedsavingsprogram/Downloads/Shared-Savings-Losses-Assignment-Spec-V7.pdf").



```{r read_data, message=FALSE}

# Read in .csv data

aco <- 
  read.csv("data/2018_Shared_Savings_Program__SSP__Accountable_Care_Organizations__ACO__PUF.csv") %>%
  
  # In order to reduce the amount of data we're working with, I'm removing some
  # of the more detailed aspects of the dataset.
  
  select(-contains("N_"), -contains("P_")) %>%
  
  # Turns string ACO_State into a list object

  mutate(ACO_State = map(ACO_State, 
                         ~ unlist(str_split(.x, ", ")))) %>%
  mutate(num_states = map(ACO_State, length),
         num_states = as.integer(num_states))

# Read in .xlsx data dictionary

aco_dictionary <-
  read_excel("data-dictionary/Dictionary.ACO.SSP.PUF.Y2018.xlsx",
             sheet = "ACO PUF Dictionary 2018",
             skip = 16,
             col_names = TRUE)


state = data.frame(
  Abbreviation = state.abb,
  Division = state.division,
  Name = state.name,
  Region = state.region
)

```


```{r functions}

# Function to look in the dictionary and find the definition of a column. 

find_definition_aco <- function(variable, col = c("short", "long", "type")) {
  col <- match.arg(col)
  aco_dictionary %>%
    filter(Variable == variable) %>%
    pull(
      switch(col,
         short = "Short Description",
         long = "Long Description",
         type = "Format/Values"))
}
```

### Understanding the ACO dataset

I wanted to look at how ACOs were distributed in terms of the ACO Track Type. For further information on the Track Types, [read here](http://www.physiciansadvocacyinstitute.org/Portals/0/assets/docs/Advanced-APM-Pathway/Medicare%20Shared%20Savings%20Program%20Overview.pdf).

- Track 1 : One-sided risk
- Track 1+ : Two-sided risk
- Track 2 : Two-sided risk
- Track 3 : Two-sided risk


```{r aco, include = FALSE}

aco %>%
  count(Agree_Type)

tracks <- aco %>%
  summarise(
    sum(Initial_Track_1),
    sum(Initial_Track_1_Plus),
    sum(Initial_Track_2),
    sum(Initial_Track_3),
    sum(Current_Track_1),
    sum(Current_Track_1_Plus),
    sum(Current_Track_2),
    sum(Current_Track_3)
  ) %>%
  gather(key = "Type", value = "Count") %>%
  separate("Type", into = c("A", "Type", "C", "Track","E")) %>%
  select(-A, -C) %>%
  unite("Track", c("Track", "E"), sep = " ")
  
ggplot(tracks, aes(x = Track, y = Count, fill = Type)) + 
  geom_col(position = "dodge") +
  labs(
    title = "Number of ACOs by Track",
    subtitle = "between Initial and Current enrollment",
    y = "# of ACOs"
  ) +
  theme_classic()
```


```{r}
# Generated Total Savings / Losses

generate_pos_neg <-  aco %>% select(GenSaveLoss) %>%
  mutate(Amount = "Zero") %>%
  mutate(Amount = ifelse(GenSaveLoss > 0, "Positive", Amount)) %>%
  mutate(Amount = ifelse(GenSaveLoss < 0, "Negative", Amount)) %>%
  count(Amount)

ggplot(generate_pos_neg, aes(x = Amount, y = n)) + geom_col()

ggplot(aco, aes(x=GenSaveLoss, fill = Agree_Type)) + 
  geom_density(alpha = 0.4) +
  scale_x_continuous(labels = scales::comma) +
  labs(
    title = "Distribution of Generated Losses and Savings (in Dollars)",
    x = "Generated Losses and Savings"
  )

ggplot(aco %>% filter(GenSaveLoss != 0), 
       aes(x=GenSaveLoss, fill = Agree_Type)) + 
  geom_density(alpha = 0.4) +
  scale_x_continuous(labels = scales::comma) +
  labs(
    title = "Distribution of non-Zero Generated Losses and Savings (in Dollars)",
    x = "Generated Losses and Savings"
  ) + geom_vline(aes(xintercept = mean(GenSaveLoss, color = Agree_Type)))
  
```

### How many states does a single ACO operate in?

As you can see, a single ACO can operate in multiple states. Here we try to explore the variation of states each ACO operates in. 

```{r}

aco %>%
  select(ACO_State, ACO_ID, Agree_Type) %>%
  head(10)

aco %>% 
  count(num_states, Agree_Type) %>%
  ggplot(aes(x = as.factor(num_states), y = n, fill = Agree_Type)) +
  geom_col(position = "dodge") +
  geom_text(aes(x = num_states, y = n, label = n, color = Agree_Type), position = position_dodge(width = 1), vjust = -0.5, size = 3, show.legend = F) + 
  labs(
    title = "In how many states does a single ACO operate?",
    subtitle = "There are no ACOs in their Renewal agreement that operate in more than 4 states",
    x = "Number of States",
    fill = "Agreement Type"
  ) +
  theme_classic() +
  theme(
    axis.title.y = element_blank(),
    axis.line.y = element_blank(),
    axis.ticks = element_blank(),
    axis.text.y = element_blank(),
    legend.position = "top"
  )
```

#### Multi-state ACOs

Who are ACOs that are operating in more than 5 states? Which states are those?

```{r}
large_acos <- aco %>%
  filter(num_states > 4) %>%
  select(ACO_State, ACO_Name)

large_acos

choose_aco <- function(index = c(1:11)){
  unlist(large_acos[index,"ACO_State"])
}

choose_aco(4)

library(usmap)

plots <- map(1:11, ~plot_usmap(include = choose_aco(.x)) +
      labs(
        title = "Locations of multi-state ACOs",
        subtitle = large_acos[.x, "ACO_Name"]
      ))

walk(plots, print)
```


#### Single-state ACOs


```{r}
single_aco <- aco %>%
  filter(num_states == 1) %>%
  mutate(ACO_State = unlist(ACO_State)) %>%
  group_by(Agree_Type) %>%
  count(ACO_State) %>%
  mutate(state = ACO_State)

initial_single_aco <- single_aco %>%
  filter(Agree_Type == "Initial")

renewal_single_aco <- single_aco %>%
  filter(Agree_Type == "Renewal")

plot_usmap(data = initial_single_aco, values = "n", color = "red") + 
  labs(
    title = "Single-state ACOs locations",
    subtitle = "Initial Agreement Type"
  ) +
  scale_fill_continuous(name = "Number of Single-state ACOs", low = "white", high = "red") + 
  theme(legend.position = "right")

plot_usmap(data = renewal_single_aco, values = "n", color = "red") + 
  labs(
    title = "Single-state ACOs locations",
    subtitle = "Renewal Agreement Type"
  ) +
  scale_fill_continuous(name = "Number of Single-state ACOs", low = "white", high = "red") + 
  theme(legend.position = "right")

```

There are 4 types of beneficiaries that are categorized to account for risk adjustments:

1. ESRD (End Stage Renal Disease)
    Eligible for Medicare as a result of End Stage Renal Disease
2. Disabled
    Eligible for Medicare as a result of disability
3. Aged/Dual
    Eligible for Medicare by age (65+) and eligible for Medicaid
4. Aged/Non-Dual
    Eligible only for Medicare by age (65+)


