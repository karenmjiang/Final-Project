---
title: "Extract Transform Load - Beneficiaries"
author: "Karen Jiang"
date: "3/3/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(tidycensus)
library(readr)
library(readxl)
library(gt)
library(usmap)
library(tidyverse)
library(ggrepel)
library(ggthemes)
```

## Exploratory Data Analysis - Part 2

* ACO general information
* **Beneficiaries information by ACO**
* **Fee-for-Service Expenditures by County**

To better understand how MSSP scoring and classifications for ACOs, information can be found in the  [MSSP Shared Savings and Losses Assignement and Methodology ]("https://www.cms.gov/Medicare/Medicare-Fee-for-Service-Payment/sharedsavingsprogram/Downloads/Shared-Savings-Losses-Assignment-Spec-V7.pdf").

```{r read_data, include=FALSE}

# GEODATA

# Variable "B00001_001" is a county population estimate.

census_api_key("6c3bf75163fa1ef1eb5aff46febb50bfb040b127")

geo_data <- get_acs(geography = "county",
        variable = "B00001_001",
        year = 2018,
        geometry = TRUE)

# BENEFICIARIES DATA

beneficiaries <- 
  read_csv("data/2018_Number_of_ACO_Assigned_Beneficiaries_by_County_PUF.csv")

beneficiaries_dictionary <-
  read_excel("data-dictionary/Dictionary.ACO.SSP.COUNTY.ASSIGNED.PUF.2018.xlsx",
             sheet = "Data Dictionary",
             col_names = TRUE)

# COUNTY FEE FOR SERVICE DATA

ffs <- 
  read_csv("data/2018_County-level_FFS_Data_for_Shared_Savings_Program_Benchmark_PUF.csv")

ffs_dictionary <-
  read_excel("data-dictionary/Dictionary.ACO.SSP.COUNTYRATE.PUF.PY19.2018.xlsx",
             sheet = "Data Dictionary",
             col_names = TRUE)
```

```{r functions, include=FALSE}

# Helper functions to quickly call on the variable definitions.

find_definition_beneficiaries <- function(variable, col = c("short", "long", "type")) {
  col <- match.arg(col)
  beneficiaries_dictionary %>%
    filter(`Variable Name` == variable) %>%
    pull(
      switch(col,
         short = "Short Description",
         long = "Long Description",
         type = "Missing or Suppressed Values"))
}


find_definition_ffs <- function(variable, col = c("short","long","type")) {
  col <- match.arg(col)
  ffs_dictionary %>%
    filter(`Variable Name` == variable) %>%
    pull(
      switch(col,
             short = "Short Description",
             long = "Long Description",
             type = "Missing or Suppressed Values"))
}

# Example: 
# find_definition_ffs("County_ID", "long")
```


### Understanding the Beneficiaries dataset

#### Saturation
```{r}

unique_acos <- length(unique(beneficiaries$`ACO ID`))

```
There are `r unique_acos` unique ACOs in this dataset. 

```{r aco_state}
num_acos_by_state <- beneficiaries %>% 
  group_by(`State name`) %>%
  count(`ACO ID`) %>%
  count(`State name`)

ggplot(num_acos_by_state, aes(y= reorder(`State name`, n), x=n)) + 
  geom_text(aes(label = n, size = "12")) + 
  theme_classic() +
  theme(
    axis.ticks = element_blank(),
    aspect.ratio = 2.5,
    axis.line.x.bottom = element_blank(),
    axis.text.x.bottom = element_blank(),
    legend.position = "none"
  ) +
  labs(
    x = "Number of ACOs",
    y = "US States and Territories"
  )

```
If we look within a State, say Massachusetts, ACOs may also be unevenly distributed within between counties.

```{r geo_state}
beneficiaries <- beneficiaries %>%
  mutate(`Total assigned beneficiaries` = na_if(x = beneficiaries$`Total assigned beneficiaries`, y = "*"))

geo_beneficiares <- beneficiaries %>%
  mutate(GEOID = paste(`State ID`, `County ID`, sep = "")) %>%
  right_join(geo_data, by = "GEOID") 

geo_data %>%
  ggplot() +
  geom_sf()


```


We can first choose to look at the total number of assigned beneficiaries per county. The values for this dataset are: `r find_definition_beneficiaries("Tot_AB", "type")`

What proportion of counties have less than 10 Total Assigned Beneficiaries? 
```{r}
beneficiaries %>%
  filter(`Total assigned beneficiaries` == "*") %>%
  length()
```

